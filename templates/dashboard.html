<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PetCare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dashboard-body" data-first-login="{{ is_first_login|lower }}">
    <!-- Dashboard Navigation -->
    <nav class="dashboard-nav">
        <div class="dashboard-nav-header">
            <a href="{{ url_for('index') }}" class="logo">Pawsphere</a>
        </div>
        <div class="dashboard-nav-links">
            <a href="#overview" class="nav-item active" data-section="overview">
                <i class="fas fa-home"></i>
                <span>Overview</span>
            </a>
            <a href="#activity" class="nav-item" data-section="activity">
                <i class="fas fa-running"></i>
                <span>Daily Activity</span>
            </a>
            <a href="#medical" class="nav-item" data-section="medical">
                <i class="fas fa-heartbeat"></i>
                <span>Medical Records</span>
            </a>
            <a href="#nutrition" class="nav-item" data-section="nutrition">
                <i class="fas fa-utensils"></i>
                <span>Nutrition</span>
            </a>
            <a href="#canine" class="nav-item" data-section="canine">
                <i class="fas fa-paw"></i>
                <span>Canine Corner</span>
            </a>
            <a href="#profile" class="nav-item" data-section="profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </div>
        <div class="dashboard-nav-footer">
            <a href="#" onclick="confirmLogout(event)" class="nav-item logout-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
    </nav>

    <!-- Main Dashboard Content -->
    <main class="dashboard-main">
        <!-- Welcome Section -->
        <section class="dashboard-welcome">
            <div class="welcome-content">
                <h1>Welcome back, {{ current_user.name }}!</h1>
                <p>Here's what's happening with your pets today.</p>
            </div>
            <div class="quick-actions">
                <button class="edit-pet-btn" onclick="showPetModal()">
                    <i class="fas fa-edit"></i>
                    Edit Pet
                </button>
            </div>
        </section>

        <!-- Overview Section -->
        <section id="overview" class="dashboard-section active">
            <h2>Overview</h2>
            <div class="dashboard-grid">
                <!-- Pet Status Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="fas fa-paw"></i>
                        <h3>Pet Status</h3>
                    </div>
                    <div class="card-content">
                        <div class="pet-status">
                            {% if pets %}
                                {% for pet in pets %}
                                    <div class="status-item">
                                        <span class="status-label">Name</span>
                                        <span class="status-value">{{ pet.name }}</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Age</span>
                                        <span class="status-value">{{ pet.age }} years</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Breed</span>
                                        <span class="status-value">{{ pet.breed }}</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Weight</span>
                                        <span class="status-value">{{ pet.weight }} kg</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Added</span>
                                        <span class="status-value">{{ pet.created_at.split('T')[0] }}</span>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="no-pets-message">
                                    <i class="fas fa-paw"></i>
                                    <p>No pets added yet. Click "Add Pet" to get started!</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Daily Activity Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="fas fa-running"></i>
                        <h3>Today's Activity</h3>
                    </div>
                    <div class="card-content">
                        <div class="upcoming-activities">
                            <h4><i class="fas fa-clock"></i> Next Activities</h4>
                            <div class="upcoming-activity-grid" id="upcomingActivities">
                                {% if medical_schedules is defined and medical_schedules.schedules is defined and current_user.email in medical_schedules.schedules %}
                                    {% set uncompleted_schedules = [] %}
                                    {% for schedule in medical_schedules.schedules[current_user.email] %}
                                        {% if schedule.status != 'completed' %}
                                            {% set _ = uncompleted_schedules.append(schedule) %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if uncompleted_schedules|length > 0 %}
                                        {% for schedule in uncompleted_schedules[:2]|sort(attribute='date') %}
                                            <div class="upcoming-activity-card">
                                                <div class="activity-info">
                                                    <div class="activity-time">
                                                        <i class="far fa-calendar"></i>
                                                        {{ schedule.date }}
                                                    </div>
                                                    <div class="activity-name">
                                                        {{ schedule.type|title }} Appointment
                                                    </div>
                                                    {% if schedule.notes %}
                                                    <div class="activity-notes">
                                                        {{ schedule.notes }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="activity-icon">
                                                    {% if schedule.type == 'dental' %}
                                                        <i class="fas fa-tooth"></i>
                                                    {% elif schedule.type == 'vaccination' %}
                                                        <i class="fas fa-syringe"></i>
                                                    {% elif schedule.type == 'checkup' %}
                                                        <i class="fas fa-stethoscope"></i>
                                                    {% else %}
                                                        <i class="fas fa-calendar-check"></i>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="no-activities">
                                            <i class="fas fa-calendar-times"></i>
                                            <p>No upcoming medical schedules</p>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="no-activities">
                                        <i class="fas fa-calendar-times"></i>
                                        <p>No medical schedules available</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Events Card -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <i class="fas fa-calendar-check"></i>
                        <h3>Upcoming Events</h3>
                    </div>
                    <div class="card-content">
                        <div class="event-list">
                            {% if medical_schedules is defined and medical_schedules.schedules is defined and current_user.email in medical_schedules.schedules %}
                                {% set uncompleted_schedules = [] %}
                                {% for schedule in medical_schedules.schedules[current_user.email] %}
                                    {% if schedule.status != 'completed' %}
                                        {% set _ = uncompleted_schedules.append(schedule) %}
                                    {% endif %}
                                {% endfor %}

                                {% if uncompleted_schedules|length > 0 %}
                                    {% for schedule in uncompleted_schedules|sort(attribute='date') %}
                                        <div class="event-item">
                                            <div class="event-date">
                                                <span class="day">{{ schedule.date.split('-')[2] }}</span>
                                                <span class="month">{{ schedule.date.split('-')[1] }}</span>
                                            </div>
                                            <div class="event-details">
                                                <h4>{{ schedule.type|title }} Appointment</h4>
                                                {% if schedule.notes %}
                                                    <p>{{ schedule.notes }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="no-events">
                                        <i class="fas fa-calendar-times"></i>
                                        <p>No upcoming schedules</p>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="no-events">
                                    <i class="fas fa-calendar-times"></i>
                                    <p>No upcoming schedules</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Health Metrics Card -->
                <!-- <div class="dashboard-card">
                    <div class="card-header">
                        <i class="fas fa-heartbeat"></i>
                        <h3>Health Metrics</h3>
                    </div>
                    <div class="card-content">
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <span class="metric-value">98.6°F</span>
                                <span class="metric-label">Temperature</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-value">120/80</span>
                                <span class="metric-label">Blood Pressure</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-value">15 kg</span>
                                <span class="metric-label">Weight</span>
                            </div>
                        </div>
                    </div>
                </div> -->
            </div>
        </section>

        <!-- Activity Section -->
        <div id="activity" class="section">
            <div class="section-header">
                <h2>Daily Activity Schedule</h2>
            </div>
            <div class="activity-container">
                {% if pets %}
                    {% for pet in pets %}
                    <div class="activity-card">
                        <div class="activity-header">
                            <h3>{{ pet.name }}</h3>
                            <span class="breed-tag">{{ pet.breed }}</span>
                        </div>
                        <div class="activity-info">
                            <div class="energy-info">
                                <span class="energy-level">Energy Level: <strong id="energy-level-{{ loop.index }}">Loading...</strong></span>
                                <span class="exercise-needs">Exercise Needs: <strong id="exercise-needs-{{ loop.index }}">Loading...</strong></span>
                            </div>
                            <div class="schedule-container">
                                <div class="schedule-list" id="schedule-list-{{ loop.index }}">
                                    <!-- Schedule will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-pets-message">
                        <i class="fas fa-paw"></i>
                        <p>No pets added yet. Click "Add Pet" to get started!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Medical Records Section -->
        <section id="medical" class="dashboard-section">
            <h2>Medical Records</h2>
            <div class="medical-records-container">
                <!-- Vaccination Recommendations -->
                <div class="medical-card">
                    <div class="card-header">
                        <i class="fas fa-syringe"></i>
                        <h3>Vaccination Schedule</h3>
                    </div>
                    <div class="card-content">
                        {% if pets %}
                            {% for pet in pets %}
                            <div class="pet-vaccination">
                                <h4>{{ pet.name }} ({{ pet.breed }})</h4>
                                <div class="vaccination-list" id="vaccination-list-{{ loop.index }}">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-pets-message">
                                <i class="fas fa-paw"></i>
                                <p>No pets added yet. Add a pet to see vaccination recommendations!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Grooming Recommendations -->
                <div class="medical-card">
                    <div class="card-header">
                        <i class="fas fa-cut"></i>
                        <h3>Grooming Schedule</h3>
                    </div>
                    <div class="card-content">
                        {% if pets %}
                            {% for pet in pets %}
                            <div class="pet-grooming">
                                <h4>{{ pet.name }} ({{ pet.breed }})</h4>
                                <div class="grooming-list" id="grooming-list-{{ loop.index }}">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-pets-message">
                                <i class="fas fa-paw"></i>
                                <p>No pets added yet. Add a pet to see grooming recommendations!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Medical Checkup Scheduler -->
                <div class="medical-card">
                    <div class="card-header">
                        <i class="fas fa-calendar-check"></i>
                        <h3>Checkup Scheduler</h3>
                    </div>
                    <div class="card-content">
                        <div class="checkup-scheduler">
                            <form id="checkupForm" class="scheduler-form">
                                <div class="form-group">
                                    <label for="checkupType">Checkup Type</label>
                                    <select id="checkupType" name="type" required>
                                        <option value="">Select type</option>
                                        <option value="routine">Routine Checkup</option>
                                        <option value="vaccination">Vaccination</option>
                                        <option value="dental">Dental Checkup</option>
                                        <option value="special">Special Consultation</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="checkupDate">Preferred Date</label>
                                    <input type="date" id="checkupDate" name="date" required>
                                </div>
                                <div class="form-group">
                                    <label for="checkupNotes">Notes</label>
                                    <textarea id="checkupNotes" name="notes" rows="3"></textarea>
                                </div>
                                <button type="submit" class="submit-button">Schedule Checkup</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Medical Schedules -->
                <div class="upcoming-schedule">
                    <div class="schedule-header">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>Upcoming Medical Schedules</h3>
                    </div>
                    <div class="schedule-content">
                        <div class="schedules-list" id="schedulesList">
                            <!-- Schedules will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Nutrition Section -->
        <section id="nutrition" class="dashboard-section">
            <h2>Nutrition Recommendations</h2>
            <div class="nutrition-grid">
                {% if pets %}
                    {% for pet in pets %}
                    <div class="nutrition-card" data-breed="{{ pet.breed }}">
                        <div class="card-header">
                            <i class="fas fa-utensils"></i>
                            <h3>{{ pet.name }}'s Diet Plan</h3>
                        </div>
                        <div class="card-content">
                            <div class="pet-nutrition" id="nutrition-{{ loop.index }}">
                                <div class="nutrition-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading nutrition data...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="nutrition-card">
                        <div class="card-header">
                            <i class="fas fa-utensils"></i>
                            <h3>Daily Diet Plan</h3>
                        </div>
                        <div class="card-content">
                            <div class="no-pets-message">
                                <i class="fas fa-paw"></i>
                                <p>No pets added yet. Add a pet to see nutrition recommendations!</p>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <div class="nutrition-card">
                    <div class="card-header">
                        <i class="fas fa-info-circle"></i>
                        <h3>Nutrition Tips</h3>
                    </div>
                    <div class="card-content">
                        <div class="nutrition-tips" id="nutrition-tips">
                            <div class="tips-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading nutrition tips...</p>
                            </div>
                            <div class="tips-list" style="display: none;">
                                <!-- Tips will be dynamically inserted here -->
                            </div>
                            <div class="no-tips" style="display: none;">
                                <i class="fas fa-leaf"></i>
                                <p>No nutrition tips available at the moment.</p>
                                <button onclick="refreshTips()">
                                    <i class="fas fa-sync-alt"></i> Refresh Tips
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Canine Corner Section -->
        <section id="canine" class="dashboard-section">
            <div class="shop-header-title">
                <h2>Canine Corner Shop</h2>
                <button class="booking-history-btn" onclick="showBookingHistory()">
                    <i class="fas fa-history"></i>
                </button>
            </div>
            
            <!-- Search and Categories Bar -->
            <div class="shop-header">
                <div class="search-bar">
                    <input type="text" id="product-search" placeholder="Search products...">
                    <button type="button" onclick="searchProducts()">
                        <i class="fas fa-search"></i>
                </button>
                </div>
                <div class="categories">
                    <button class="category-btn active" data-category="all">All</button>
                    <button class="category-btn" data-category="food">Food</button>
                    <button class="category-btn" data-category="toys">Toys</button>
                    <button class="category-btn" data-category="accessories">Accessories</button>
                    <button class="category-btn" data-category="health">Health & Wellness</button>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="products-grid" id="productsGrid">
                <!-- Product cards will be dynamically populated -->
            </div>
        </section>

        <!-- Product Details Modal -->
        <div class="modal" id="productModal">
            <div class="modal-content product-modal">
                    <div class="modal-header">
                    <h2>Product Details</h2>
                    <button class="close-button" onclick="closeProductModal()">×</button>
                    </div>
                <div class="modal-body" id="productDetails">
                    <!-- Product details will be dynamically populated -->
                </div>
                <div class="modal-footer">
                    <button class="book-now-btn" onclick="openBookingModal()">
                        <i class="fas fa-calendar-check"></i>
                        Book Now
                    </button>
                    </div>
                </div>
            </div>

        <!-- Shopping Cart Modal -->
        <div class="modal" id="cartModal">
            <div class="modal-content cart-modal">
                <div class="modal-header">
                    <h2>Shopping Cart</h2>
                    <button class="close-button" onclick="closeCartModal()">×</button>
                </div>
                <div class="modal-body" id="cartItems">
                    <!-- Cart items will be dynamically populated -->
                </div>
                <div class="modal-footer">
                    <div class="cart-total">
                        <span>Total:</span>
                        <span id="cartTotal">$0.00</span>
                    </div>
                    <button class="checkout-btn" onclick="checkout()">
                        Proceed to Checkout
                    </button>
                </div>
            </div>
        </div>

        <!-- Booking Modal -->
        <div id="bookingModal" class="modal">
            <div class="modal-content booking-modal">
                <span class="close" onclick="closeBookingModal()">&times;</span>
                <h2>Book Your Product</h2>
                <div class="booking-details">
                    <div class="product-summary">
                        <img id="bookingProductImage" src="" alt="Product Image">
                        <div class="product-info">
                            <h3 id="bookingProductName"></h3>
                            <p id="bookingProductDescription"></p>
                            <div class="quantity-selector">
                                <label for="quantity">Quantity:</label>
                                <div class="quantity-controls">
                                    <button onclick="updateQuantity(-1)">-</button>
                                    <input type="number" id="quantity" value="1" min="1" onchange="updateTotalAmount()">
                                    <button onclick="updateQuantity(1)">+</button>
                                </div>
                            </div>
                            <div class="price-details">
                                <p>Price per item: $<span id="bookingProductPrice"></span></p>
                                <p class="total-amount">Total Amount: $<span id="bookingTotalAmount"></span></p>
                            </div>
                        </div>
                    </div>
                    <div class="payment-options">
                        <h3>Select Payment Method</h3>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPaymentMethod('cod')">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Cash on Delivery</span>
                            </div>
                            <div class="payment-method" onclick="selectPaymentMethod('upi')">
                                <i class="fas fa-qrcode"></i>
                                <span>UPI Payment</span>
                            </div>
                        </div>
                        <div id="upiDetails" class="payment-details" style="display: none;">
                            <h4>UPI Payment Details</h4>
                            <div class="upi-info">
                                <p>UPI ID: pawsphere@upi</p>
                                <div class="qr-code">
                                    <img src="static/img/pawsphere-qr.png" alt="PawSphere UPI QR Code">
                                </div>
                                <p class="upi-note">Scan QR code or use UPI ID to pay</p>
                            </div>
                        </div>
                        <div id="codDetails" class="payment-details" style="display: none;">
                            <h4>Cash on Delivery</h4>
                            <p>Pay in cash when your order is delivered</p>
                            <p class="cod-note">Additional fee of $2 applies for COD</p>
                        </div>
                    </div>
                    <button class="confirm-booking-btn" onclick="confirmBooking()">
                        Confirm Booking
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <section id="profile" class="dashboard-section">
            <h2>Profile Settings</h2>
            <div class="profile-grid">
                <div class="profile-card">
                    <div class="card-header">
                        <i class="fas fa-user-circle"></i>
                        <h3>Account Information</h3>
                    </div>
                    <div class="card-content">
                        <form class="profile-form">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" value="{{ current_user.name }}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" value="{{ current_user.email }}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Member Since</label>
                                <input type="text" value="{{ current_user.created_at.split('T')[0] }}" readonly>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="profile-card">
                    <div class="card-header">
                        <i class="fas fa-lock"></i>
                        <h3>Change Password</h3>
                    </div>
                    <div class="card-content">
                        <form class="profile-form" id="changePasswordForm" onsubmit="handlePasswordChange(event)">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" name="currentPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" name="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" required>
                            </div>
                            <button type="submit" class="submit-button">Update Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Pet Details Modal -->
    <div id="petModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Pet Details</h2>
                <button class="close-button" onclick="closePetModal()">&times;</button>
            </div>
            <form id="petForm" class="modal-form" onsubmit="handlePetSubmit(event)">
                <input type="hidden" id="petId" name="id">
                <div class="form-group">
                    <label for="petName">Pet Name *</label>
                    <input type="text" id="petName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="petAge">Age (years) *</label>
                    <input type="number" id="petAge" name="age" step="0.1" min="0" required>
                </div>
                <div class="form-group">
                    <label for="petBreed">Breed *</label>
                    <select id="petBreed" name="breed" required>
                        <option value="">Select a breed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="petWeight">Weight (kg)</label>
                    <input type="number" id="petWeight" name="weight" step="0.1" min="0">
                </div>
                <div class="form-actions">
                    <button type="submit" class="submit-button">Update Pet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Booking History Modal -->
    <div id="bookingHistoryModal" class="modal">
        <div class="modal-content booking-history-modal">
            <div class="modal-header">
                <h2><i class="fas fa-history"></i> Your Booking History</h2>
                <button class="close-button" onclick="closeBookingHistoryModal()">&times;</button>
            </div>
            <div class="modal-body" id="bookingHistoryContent">
                <!-- Booking history will be populated here -->
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/activities.js') }}"></script>

    <script>
    // Store breed activities data from server
    const breedActivities = {{ breed_activities|tojson|safe }};
    console.log('Initial breed activities data:', breedActivities);
    
    // Function to handle section visibility
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.dashboard-section, .section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Show the selected section
        const selectedSection = document.getElementById(sectionId);
        if (selectedSection) {
            selectedSection.style.display = 'block';
            
            // Load appropriate data based on section
            if (sectionId === 'activity') {
                console.log('Loading breed activities for activity section');
                loadBreedActivities();
            } else if (sectionId === 'medical') {
                console.log('Loading medical data for medical section');
                loadMedicalRecommendations();
                loadMedicalSchedules();
            } else if (sectionId === 'nutrition') {
                loadNutritionData();
            }
        }
    }

    // Add click event listeners to all nav items
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(event) {
            event.preventDefault();
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Add active class to clicked nav item
            this.classList.add('active');
            
            // Get the section ID from data-section attribute
            const sectionId = this.getAttribute('data-section');
            showSection(sectionId);
        });
    });

    // Handle initial active state
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        
        // Hide all sections first
        document.querySelectorAll('.dashboard-section, .section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.classList.remove('active');
        });
        
        // Set overview as active by default
        const overviewNav = document.querySelector('.nav-item[data-section="overview"]');
        const overviewSection = document.getElementById('overview');
        
        if (overviewNav && overviewSection) {
            overviewNav.classList.add('active');
            overviewSection.style.display = 'block';
        }
        
        // Check URL hash after setting default
        const hash = window.location.hash.slice(1);
        if (hash && hash !== 'overview') {
            const activeNav = document.querySelector(`.nav-item[data-section="${hash}"]`);
            if (activeNav) {
                activeNav.classList.remove('active');
                activeNav.classList.add('active');
                showSection(hash);
            }
        }

        // Load initial data
        loadMedicalSchedules();
        loadBreedActivities();
    });

    function showPetModal() {
        const modal = document.getElementById('petModal');
        modal.style.display = 'flex';
        loadBreeds();
        
        // Get the first pet's data (assuming we're editing the first pet for now)
        const petData = {{ pets|tojson|safe }};
        if (petData && petData.length > 0) {
            const pet = petData[0]; // Get the first pet
            document.getElementById('petId').value = pet.id;
            document.getElementById('petName').value = pet.name;
            document.getElementById('petAge').value = pet.age;
            document.getElementById('petWeight').value = pet.weight || '';
            
            // Set the breed after breeds are loaded
            const breedSelect = document.getElementById('petBreed');
            if (breedSelect) {
                breedSelect.value = pet.breed;
            }
        }
    }

    function closePetModal() {
        const modal = document.getElementById('petModal');
        modal.style.display = 'none';
        document.getElementById('petForm').reset();
    }

    async function loadBreeds() {
        try {
            const response = await fetch('/api/breeds');
            const data = await response.json();
            const breedSelect = document.getElementById('petBreed');
            breedSelect.innerHTML = '<option value="">Select a breed</option>';
            
            data.breeds.sort().forEach(breed => {
                const option = document.createElement('option');
                option.value = breed;
                option.textContent = breed;
                breedSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading breeds:', error);
            showNotification('Error loading breeds', 'error');
        }
    }

    async function handlePetSubmit(event) {
        event.preventDefault();
        
        const formData = {
            id: document.getElementById('petId').value,
            name: document.getElementById('petName').value,
            age: document.getElementById('petAge').value,
            breed: document.getElementById('petBreed').value,
            weight: document.getElementById('petWeight').value
        };

        try {
            const response = await fetch('/api/pets', {
                method: 'PUT', // Changed to PUT for updates
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('Pet updated successfully!', 'success');
                closePetModal();
                // Refresh the page to show the updated pet
                window.location.reload();
            } else {
                showNotification(data.error || 'Error updating pet', 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error updating pet', 'error');
        }
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('petModal');
        if (event.target === modal) {
            closePetModal();
        }
    }

    function confirmLogout(event) {
        event.preventDefault();
        if (confirm('Are you sure you want to logout?')) {
            window.location.href = "{{ url_for('logout') }}";
        }
    }

    function loadBreedActivities() {
        console.log('Loading breed activities...');
        fetch('/api/breed-activities')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load breed activities');
                }
                return response.json();
            })
            .then(data => {
                console.log('Received breed activities:', data);
                const pets = document.querySelectorAll('.activity-card');
                
                pets.forEach((pet, index) => {
                    const breedElement = pet.querySelector('.breed-tag');
                    const breed = breedElement.textContent;
                    const energyLevelElement = document.getElementById(`energy-level-${index + 1}`);
                    const exerciseNeedsElement = document.getElementById(`exercise-needs-${index + 1}`);
                    const scheduleList = document.getElementById(`schedule-list-${index + 1}`);
                    
                    if (!breed || !data[breed]) {
                        console.warn(`No activities found for breed: ${breed}`);
                        return;
                    }

                    const breedData = data[breed];
                    console.log(`Activities for ${breed}:`, breedData);

                    // Update energy level and exercise needs
                    energyLevelElement.textContent = breedData.energy_level;
                    exerciseNeedsElement.textContent = breedData.exercise_needs;

                    // Clear existing schedule
                    scheduleList.innerHTML = '';

                    // Sort schedule by time
                    const sortedSchedule = Object.entries(breedData.schedule)
                        .sort(([timeA], [timeB]) => timeA.localeCompare(timeB));

                    // Create schedule items
                    sortedSchedule.forEach(([time, activity]) => {
                        const scheduleItem = document.createElement('div');
                        scheduleItem.className = 'schedule-item';
                        scheduleItem.innerHTML = `
                            <span class="schedule-time">${time}</span>
                            <span class="schedule-activity">${activity}</span>
                        `;
                        scheduleList.appendChild(scheduleItem);
                    });
                });
            })
            .catch(error => {
                console.error('Error loading breed activities:', error);
                // Show error message to user
                const activityContainer = document.querySelector('.activity-container');
                if (activityContainer) {
                    activityContainer.innerHTML = `
                        <div class="error-message">
                            Failed to load breed activities. Please try again later.
                        </div>
                    `;
                }
            });
    }

    // Function to load vaccination and grooming recommendations
    function loadMedicalRecommendations() {
        const pets = document.querySelectorAll('.pet-vaccination, .pet-grooming');
        
        pets.forEach((pet, index) => {
            const breed = pet.querySelector('h4').textContent.match(/\((.*?)\)/)[1];
            const vaccinationList = document.getElementById(`vaccination-list-${index + 1}`);
            const groomingList = document.getElementById(`grooming-list-${index + 1}`);
            
            // Get breed-specific recommendations from the server
            fetch(`/api/breed-recommendations/${breed}`)
                .then(response => response.json())
                .then(data => {
                    // Populate vaccination recommendations
                    if (data.vaccinations) {
                        vaccinationList.innerHTML = data.vaccinations.map(vaccine => `
                            <div class="vaccination-item">
                                <span>${vaccine.name}</span>
                                <span>${vaccine.schedule}</span>
                            </div>
                        `).join('');
                    }

                    // Populate grooming recommendations
                    if (data.grooming) {
                        groomingList.innerHTML = data.grooming.map(groom => `
                            <div class="grooming-item">
                                <span>${groom.type}</span>
                                <span>${groom.frequency}</span>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error loading recommendations:', error);
                });
        });
    }

    // Handle checkup scheduling
    document.getElementById('checkupForm').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const formData = {
            type: document.getElementById('checkupType').value,
            date: document.getElementById('checkupDate').value,
            notes: document.getElementById('checkupNotes').value
        };

        fetch('/api/schedule-checkup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Checkup scheduled successfully!', 'success');
                this.reset();
                loadMedicalSchedules(); // Reload the schedules list
            } else {
                showNotification(data.error || 'Failed to schedule checkup', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error scheduling checkup', 'error');
        });
    });

    // Function to load and display medical schedules
    function loadMedicalSchedules() {
        console.log('Loading medical schedules...');
        fetch('/api/medical-schedules')
            .then(response => response.json())
            .then(data => {
                console.log('Received medical schedules:', data);
                const schedulesList = document.getElementById('schedulesList');
                if (!schedulesList) return;

                if (!data.schedules || data.schedules.length === 0) {
                    schedulesList.innerHTML = `
                        <div class="no-schedules-message">
                            <i class="fas fa-calendar-times"></i>
                            <p>No upcoming medical schedules</p>
                        </div>
                    `;
                    return;
                }

                // Sort schedules by date
                const sortedSchedules = data.schedules.sort((a, b) => 
                    new Date(a.date) - new Date(b.date)
                );

                schedulesList.innerHTML = sortedSchedules.map(schedule => `
                    <div class="schedule-item">
                        <div class="schedule-date">
                            <span class="day">${new Date(schedule.date).getDate()}</span>
                            <span class="month">${new Date(schedule.date).toLocaleString('default', { month: 'short' })}</span>
                        </div>
                        <div class="schedule-details">
                            <h4>${schedule.type.charAt(0).toUpperCase() + schedule.type.slice(1)} Checkup</h4>
                            ${schedule.notes ? `<p class="schedule-notes">${schedule.notes}</p>` : ''}
                        </div>
                        <div class="schedule-actions">
                            <div class="schedule-status ${schedule.status}">
                                ${schedule.status.charAt(0).toUpperCase() + schedule.status.slice(1)}
                            </div>
                            <div class="action-buttons">
                                ${schedule.status === 'scheduled' ? `
                                    <button class="action-button complete" onclick="updateScheduleStatus('${schedule.id}', 'completed')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                                <button class="action-button delete" onclick="deleteSchedule('${schedule.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading medical schedules:', error);
                const schedulesList = document.getElementById('schedulesList');
                if (schedulesList) {
                    schedulesList.innerHTML = `
                        <div class="error-message">
                            Failed to load medical schedules. Please try again later.
                        </div>
                    `;
                }
            });
    }

    // Function to update schedule status
    function updateScheduleStatus(scheduleId, newStatus) {
        fetch(`/api/medical-schedules/${scheduleId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Schedule status updated successfully!', 'success');
                loadMedicalSchedules(); // Reload the schedules list
            } else {
                showNotification(data.error || 'Failed to update schedule status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error updating schedule status', 'error');
        });
    }

    // Function to delete schedule
    function deleteSchedule(scheduleId) {
        if (confirm('Are you sure you want to delete this schedule?')) {
            fetch(`/api/medical-schedules/${scheduleId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Schedule deleted successfully!', 'success');
                    loadMedicalSchedules(); // Reload the schedules list
                } else {
                    showNotification(data.error || 'Failed to delete schedule', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error deleting schedule', 'error');
            });
        }
    }

    // Load recommendations when the medical section is shown
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            if (this.getAttribute('data-section') === 'medical') {
                loadMedicalRecommendations();
            }
        });
    });

    // Function to load nutrition data
    function loadNutritionData() {
        console.log('Loading nutrition data...');
        const pets = document.querySelectorAll('.pet-nutrition');
        
        pets.forEach((pet, index) => {
            const nutritionCard = pet.closest('.nutrition-card');
            const breed = nutritionCard.dataset.breed;
            console.log(`Loading nutrition data for breed: ${breed}`);
            
            fetch(`/api/breed-nutrition/${encodeURIComponent(breed)}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `HTTP error! status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Received nutrition data for ${breed}:`, data);
                    if (!data) {
                        throw new Error('No data received from server');
                    }

                    const nutritionHtml = `
                        <div class="diet-plan">
                            <div class="nutrition-info">
                                <div class="calories-info">
                                    <span class="label">Daily Calories:</span>
                                    <span class="value">${data.daily_calories || 'Not specified'}</span>
                                </div>
                                <div class="meals-info">
                                    <span class="label">Meals per Day:</span>
                                    <span class="value">${data.meals_per_day || 'Not specified'}</span>
                                </div>
                            </div>
                            <div class="meal-times">
                                ${data.diet_plan && Object.entries(data.diet_plan)
                                    .filter(([key]) => key !== 'snacks')
                                    .map(([time, details]) => `
                                        <div class="meal-time">
                                            <h4>${time.charAt(0).toUpperCase() + time.slice(1)}</h4>
                                            <p class="time">${details.time || 'Not specified'}</p>
                                            <p class="food">${details.food || 'Not specified'}</p>
                                            ${details.supplements ? `<p class="supplements">${details.supplements}</p>` : ''}
                                            <p class="water">${details.water || 'Fresh water'}</p>
                                        </div>
                                    `).join('') || '<p class="no-data">No meal times specified</p>'}
                            </div>
                            <div class="snacks-section">
                                <h4>Recommended Snacks</h4>
                                <ul class="snacks-list">
                                    ${data.diet_plan && data.diet_plan.snacks ? 
                                        data.diet_plan.snacks.map(snack => `<li>${snack}</li>`).join('') :
                                        '<li>No snacks specified</li>'}
                                </ul>
                            </div>
                        </div>
                    `;
                    document.querySelector(`#nutrition-${index + 1}`).innerHTML = nutritionHtml;
                })
                .catch(error => {
                    console.error(`Error loading nutrition data for ${breed}:`, error);
                    const errorMessage = error.message.includes('suggestions') ? 
                        `Breed "${breed}" not found. Please check the breed name or contact support.` :
                        `Failed to load nutrition data for ${breed}. Please try again later.`;
                    
                    document.querySelector(`#nutrition-${index + 1}`).innerHTML = `
                        <div class="error-message">
                            ${errorMessage}
                        </div>
                    `;
                });
        });

        // Load nutrition tips for the first pet
        if (pets.length > 0) {
            const firstPetCard = document.querySelector('.nutrition-card');
            const breed = firstPetCard.dataset.breed;
            console.log(`Loading nutrition tips for breed: ${breed}`);
            
            fetch(`/api/breed-nutrition/${encodeURIComponent(breed)}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `HTTP error! status: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Received nutrition tips for ${breed}:`, data);
                    if (!data) {
                        throw new Error('No data received from server');
                    }

                    const tipsHtml = `
                        <ul class="tips-list">
                            ${data.nutrition_tips && data.nutrition_tips.length > 0 ? 
                                data.nutrition_tips.map(tip => `<li>${tip}</li>`).join('') :
                                '<li>No nutrition tips available</li>'}
                        </ul>
                        <div class="food-restrictions">
                            <h4>Foods to Avoid</h4>
                            <ul class="restrictions-list">
                                ${data.food_restrictions && data.food_restrictions.length > 0 ?
                                    data.food_restrictions.map(food => `<li>${food}</li>`).join('') :
                                    '<li>No food restrictions specified</li>'}
                            </ul>
                        </div>
                    `;
                    document.getElementById('nutrition-tips').innerHTML = tipsHtml;
                })
                .catch(error => {
                    console.error(`Error loading nutrition tips for ${breed}:`, error);
                    const errorMessage = error.message.includes('suggestions') ? 
                        `Breed "${breed}" not found. Please check the breed name or contact support.` :
                        `Failed to load nutrition tips. Please try again later.`;
                    
                    document.getElementById('nutrition-tips').innerHTML = `
                        <div class="error-message">
                            ${errorMessage}
                        </div>
                    `;
                });
        }
    }

    // Remove the hardcoded products array and add a variable to store products
    let products = [];
    let cart = [];

    // Initialize products when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
        setupCategoryFilters();
    });

    // Function to load products from the backend
    function loadProducts() {
        fetch('/api/products')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format: expected an array of products');
                }
                products = data;
                displayProducts(products);
            })
            .catch(error => {
                console.error('Error loading products:', error);
                document.getElementById('productsGrid').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Failed to load products. Please try again later.</p>
                        <p class="error-details">${error.message}</p>
                    </div>
                `;
            });
    }

    function displayProducts(productsToShow) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = '';

        if (!Array.isArray(productsToShow) || productsToShow.length === 0) {
            grid.innerHTML = `
                <div class="no-products-message">
                    <i class="fas fa-box-open"></i>
                    <p>No products found matching your criteria.</p>
                </div>
            `;
            return;
        }

        productsToShow.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.innerHTML = `
                <div class="product-image">
                    <img src="${product.image}" alt="${product.name}" onerror="this.src='/static/img/placeholder.jpg'">
                </div>
                <div class="product-info">
                    <h3>${product.name}</h3>
                    <p class="price">$${product.price.toFixed(2)}</p>
                    <button onclick="showProductDetails(${product.id})">View Details</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function setupCategoryFilters() {
        const buttons = document.querySelectorAll('.category-btn');
        buttons.forEach(button => {
            button.addEventListener('click', () => {
                buttons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                const category = button.dataset.category;
                if (category === 'all') {
                    displayProducts(products);
                } else {
                    // Map the button category to the actual product category
                    const categoryMap = {
                        'food': 'Food',
                        'toys': 'Toys',
                        'accessories': 'Accessories',
                        'health': 'Health & Wellness'
                    };
                    
                    const mappedCategory = categoryMap[category] || category;
                    const filtered = products.filter(product => 
                        product.category === mappedCategory
                    );
                    displayProducts(filtered);
                }
            });
        });
    }

    function searchProducts() {
        const searchTerm = document.getElementById('product-search').value;
        if (!searchTerm.trim()) {
            displayProducts(products);
            return;
        }

        fetch(`/api/products/search?q=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                displayProducts(data);
            })
            .catch(error => {
                console.error('Error searching products:', error);
            });
    }

    function showProductDetails(productId) {
        fetch(`/api/products/${productId}`)
            .then(response => response.json())
            .then(product => {
                currentProduct = product; // Store the current product
                const modal = document.getElementById('productModal');
                const details = document.getElementById('productDetails');
                
                details.innerHTML = `
                    <div class="product-detail-content">
                        <div class="product-detail-image">
                            <img src="${product.image}" alt="${product.name}" onerror="this.src='/static/img/placeholder.jpg'">
                        </div>
                        <div class="product-detail-info">
                            <h3>${product.name}</h3>
                            <p class="price">$${product.price.toFixed(2)}</p>
                            <p class="description">${product.description}</p>
                            <div class="features">
                                <h4>Features:</h4>
                                <ul>
                                    ${product.features.map(feature => `<li>${feature}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="stock">
                                <span class="stock-label">Stock:</span>
                                <span class="stock-value">${product.stock} available</span>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.style.display = 'flex';
            })
            .catch(error => {
                console.error('Error loading product details:', error);
                showNotification('Error loading product details', 'error');
            });
    }

    function closeProductModal() {
        document.getElementById('productModal').style.display = 'none';
    }

    function addToCart() {
        const productId = document.querySelector('.product-detail-content').dataset.productId;
        const quantity = parseInt(document.getElementById('quantity').value);
        const product = products.find(p => p.id === parseInt(productId));
        
        if (product) {
            const cartItem = {
                ...product,
                quantity: quantity
            };
            
            const existingItem = cart.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push(cartItem);
            }
            
            showNotification('Product added to cart!', 'success');
            closeProductModal();
            updateCartBadge();
        }
    }

    function updateCartBadge() {
        const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
        // Update cart badge count
    }

    function showCartModal() {
        const modal = document.getElementById('cartModal');
        const cartItems = document.getElementById('cartItems');
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        cartItems.innerHTML = cart.map(item => `
            <div class="cart-item">
                <img src="${item.image}" alt="${item.name}">
                <div class="cart-item-details">
                    <h4>${item.name}</h4>
                    <p>$${item.price.toFixed(2)} x ${item.quantity}</p>
                </div>
                <button onclick="removeFromCart(${item.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
        
        document.getElementById('cartTotal').textContent = `$${total.toFixed(2)}`;
        modal.style.display = 'flex';
    }

    function closeCartModal() {
        document.getElementById('cartModal').style.display = 'none';
    }

    function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        showCartModal(); // Refresh cart display
        updateCartBadge();
    }

    function checkout() {
        // Implement checkout logic
        alert('Checkout functionality coming soon!');
    }

    let currentProduct = null;
    let selectedPaymentMethod = null;

    function openBookingModal() {
        if (!currentProduct) {
            showNotification('Error: Product details not available', 'error');
            return;
        }

        const modal = document.getElementById('bookingModal');
        const productImage = document.getElementById('bookingProductImage');
        const productName = document.getElementById('bookingProductName');
        const productDescription = document.getElementById('bookingProductDescription');
        const productPrice = document.getElementById('bookingProductPrice');

        productImage.src = currentProduct.image;
        productImage.onerror = () => productImage.src = '/static/img/placeholder.jpg';
        productName.textContent = currentProduct.name;
        productDescription.textContent = currentProduct.description;
        productPrice.textContent = currentProduct.price.toFixed(2);

        // Reset quantity and payment method
        document.getElementById('quantity').value = 1;
        selectedPaymentMethod = null;
        resetPaymentMethods();
        updateTotalAmount();

        // Close the product details modal and show the booking modal
        closeProductModal();
        modal.style.display = 'block';
    }

    function closeBookingModal() {
        const modal = document.getElementById('bookingModal');
        modal.style.display = 'none';
        selectedPaymentMethod = null;
        resetPaymentMethods();
    }

    function updateQuantity(change) {
        const quantityInput = document.getElementById('quantity');
        const newValue = parseInt(quantityInput.value) + change;
        if (newValue >= 1) {
            quantityInput.value = newValue;
            updateTotalAmount();
        }
    }

    function updateTotalAmount() {
        const quantity = parseInt(document.getElementById('quantity').value);
        const price = parseFloat(document.getElementById('bookingProductPrice').textContent);
        const total = quantity * price;
        document.getElementById('bookingTotalAmount').textContent = total.toFixed(2);
    }

    function selectPaymentMethod(method) {
        selectedPaymentMethod = method;
        resetPaymentMethods();
        
        const selectedElement = document.querySelector(`.payment-method[onclick*="${method}"]`);
        selectedElement.classList.add('selected');
        
        document.getElementById('upiDetails').style.display = method === 'upi' ? 'block' : 'none';
        document.getElementById('codDetails').style.display = method === 'cod' ? 'block' : 'none';
    }

    function resetPaymentMethods() {
        document.querySelectorAll('.payment-method').forEach(element => {
            element.classList.remove('selected');
        });
        document.getElementById('upiDetails').style.display = 'none';
        document.getElementById('codDetails').style.display = 'none';
    }

    function confirmBooking() {
        if (!selectedPaymentMethod) {
            showNotification('Please select a payment method', 'error');
            return;
        }

        const quantity = parseInt(document.getElementById('quantity').value);
        const total = parseFloat(document.getElementById('bookingTotalAmount').textContent);
        
        const bookingData = {
            product_id: currentProduct.id,
            product_name: currentProduct.name,
            quantity: quantity,
            total_amount: total,
            payment_method: selectedPaymentMethod.toUpperCase(),
            customer_details: {
                name: "{{ current_user.name }}",
                email: "{{ current_user.email }}"
            }
        };

        // Send booking data to server
        fetch('/api/bookings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(bookingData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Booking confirmed successfully!', 'success');
                closeBookingModal();
            } else {
                showNotification(data.error || 'Failed to confirm booking', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error confirming booking', 'error');
        });
    }

    function showBookingHistory() {
        fetch('/api/bookings/user')
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Please log in to view your booking history');
                    }
                    throw new Error('Failed to load booking history');
                }
                return response.json();
            })
            .then(data => {
                const modalContent = document.getElementById('bookingHistoryContent');
                
                if (!data.bookings || data.bookings.length === 0) {
                    modalContent.innerHTML = `
                        <div class="no-bookings">
                            <i class="fas fa-calendar-times"></i>
                            <p>No bookings found</p>
                        </div>
                    `;
                } else {
                    modalContent.innerHTML = data.bookings
                        .sort((a, b) => new Date(b.booking_date) - new Date(a.booking_date))
                        .map(booking => `
                            <div class="booking-history-item">
                                <div class="booking-history-header">
                                    <div class="booking-id">
                                        <i class="fas fa-receipt"></i>
                                        Order #${booking.booking_id}
                                    </div>
                                    <div class="booking-date">
                                        <i class="far fa-calendar-alt"></i>
                                        ${new Date(booking.booking_date).toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="booking-history-details">
                                    <div class="product-info">
                                        <h4>${booking.product_name}</h4>
                                        <p class="quantity">Quantity: ${booking.quantity}</p>
                                    </div>
                                    <div class="booking-status-price">
                                        <span class="status ${booking.status.toLowerCase()}">
                                            <i class="fas fa-circle"></i>
                                            ${booking.status}
                                        </span>
                                        <span class="total-amount">$${booking.total_amount.toFixed(2)}</span>
                                    </div>
                                    <div class="payment-method ${booking.payment_method.toLowerCase()}">
                                        <i class="fas ${booking.payment_method === 'UPI' ? 'fa-mobile-alt' : 'fa-money-bill-wave'}"></i>
                                        ${booking.payment_method}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                }
                
                document.getElementById('bookingHistoryModal').style.display = 'flex';
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification(error.message || 'Error loading booking history', 'error');
            });
    }

    function closeBookingHistoryModal() {
        document.getElementById('bookingHistoryModal').style.display = 'none';
    }

    function handlePasswordChange(event) {
        event.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (newPassword !== confirmPassword) {
            showNotification('New passwords do not match', 'error');
            return;
        }
        
        fetch('/api/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_password: currentPassword,
                new_password: newPassword
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Password updated successfully', 'success');
                document.getElementById('changePasswordForm').reset();
            } else {
                showNotification(data.error || 'Failed to update password', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error updating password', 'error');
        });
    }
    </script>

    <style>
    .logout-item {
        color: #dc3545;
        transition: all 0.3s ease;
    }
    
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .confirm-booking-btn:hover {
        background: linear-gradient(135deg, #27ae60, #219a52);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .confirm-booking-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .product-summary {
        display: flex;
        gap: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .product-summary img {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
    }

    .product-info {
        flex: 1;
    }

    .quantity-selector {
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .quantity-controls button {
        padding: 5px 10px;
        border: 1px solid #ddd;
        background: #fff;
        cursor: pointer;
    }

    .quantity-controls input {
        width: 60px;
        text-align: center;
        padding: 5px;
    }

    .price-details {
        margin-top: 15px;
    }

    .total-amount {
        font-size: 1.2em;
        font-weight: bold;
        color: #2c3e50;
    }

    .payment-options {
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .payment-methods {
        display: flex;
        gap: 20px;
        margin: 20px 0;
    }

    .payment-method {
        flex: 1;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.3s ease;
    }

    .payment-method:hover {
        border-color: #3498db;
        background: #f8f9fa;
    }

    .payment-method.selected {
        border-color: #3498db;
        background: #ebf5fb;
    }

    .payment-method i {
        font-size: 24px;
        margin-bottom: 10px;
        display: block;
    }

    .payment-details {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .upi-info {
        text-align: center;
    }

    .qr-code {
        margin: 15px auto;
        max-width: 200px;
    }

    .qr-code img {
        width: 100%;
        height: auto;
    }

    .book-now-btn {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .book-now-btn i {
        font-size: 1.1rem;
    }

    .book-now-btn:hover {
        background: linear-gradient(135deg, #2980b9, #2471a3);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .book-now-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .booking-modal {
        max-width: 800px;
        width: 90%;
        max-height: 90vh;
        padding: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .booking-modal h2 {
        margin: 0;
        padding: 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .booking-details {
        display: flex;
        flex-direction: column;
        gap: 20px;
        padding: 20px;
        overflow-y: auto;
        max-height: calc(90vh - 120px); /* Account for header and padding */
    }

    .booking-details::-webkit-scrollbar {
        width: 8px;
    }

    .booking-details::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .booking-details::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
    }

    .booking-details::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    .confirm-booking-btn {
        position: sticky;
        bottom: 0;
        margin: 0 20px 20px;
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .confirm-booking-btn:hover {
        background: linear-gradient(135deg, #27ae60, #219a52);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .confirm-booking-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .booking-history-modal {
        max-width: 800px;
        width: 90%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .booking-history-modal .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
    }

    .booking-history-item {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .booking-history-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .booking-history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .booking-id {
        font-weight: 600;
        color: #2c3e50;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .booking-date {
        color: #7f8c8d;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .booking-history-details {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 15px;
        align-items: center;
    }

    .product-info h4 {
        margin-bottom: 5px;
        color: #2c3e50;
    }

    .quantity {
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .booking-status-price {
        text-align: right;
    }

    .status {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .status.confirmed {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .total-amount {
        display: block;
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.1rem;
    }

    .payment-method {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.9rem;
        width: fit-content;
    }

    .payment-method.upi {
        background: #e3f2fd;
        color: #1976d2;
    }

    .payment-method.cod {
        background: #fff3e0;
        color: #f57c00;
    }

    .no-bookings {
        text-align: center;
        padding: 40px 20px;
        color: #7f8c8d;
    }

    .no-bookings i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #bdc3c7;
    }
    </style>
</body>
</html> 